<!doctype html>
<html lang="en">
<head>
    <title>Lex Admin Panel</title>
    <link rel="stylesheet" href="bootstrap.min.css" />
    <script type="text/javascript" src="aws-sdk-2.229.1.min.js"></script>
    <script type="text/javascript" src="jquery-3.1.0.js"></script>
    <style>
        body {
            font-family: Consolas, Courier New, Courier, monospace;
        }

        .input-label {
            margin: 4px;
            width: 125px;
            float: left;
        }

        .button {
            margin: 4px;
        }

        .text {
            margin: 4px;
        }
    </style>
</head>
<body>
    <h2 class="text">Authentication</h2>
    <div><div class="input-label">ID:</div><input id="id" type="text" class="text" size="50" value="AKIAJMOKUS2ZXSLYTXSA" placeholder="Access ID" /></div>
    <div><div class="input-label">Key:</div><input id="key" type="password" class="text" size="50" value="QlP2eS7OXRDaLFarkQkJjbmxw5c366o84EMw8ZvF" placeholder="Access Key" /></div>
    <h2 class="text">Bot</h2>
    <div><div class="input-label">Name:</div><input id="bot-name" type="text" class="text" size="50" value="Playground" placeholder="Bot name" /></div>
    <em class="text">Currently only allowed access to bot "Playground"</em>
    <div><button id="check-button" class="button">Check bot status</button><span id="bot-status" class="text"></span></div>
    <h2 class="text">Intent</h2>
    <div><div class="input-label">Name:</div><input id="intent-name" type="text" class="text" size="50" placeholder="Intent name" /></div>
    <div><div class="input-label">Utterance:</div><textarea id="utterance" class="text" rows="3" cols="50" placeholder="Utterance using utterance generator syntax"></textarea></div>
    <div><div class="input-label">Text Response:</div><textarea id="text" class="text" rows="3" cols="50" placeholder="Text response. Keep within 250 characters"></textarea></div>
    <div><div class="input-label">Voice Response:</div><textarea id="voice" class="text" rows="3" cols="50" placeholder="Voice response using SSML. Keep within 150 characters"></textarea></div>
    <div><button id="submit-button" class="button">Submit</button><span id="intent-status" class="text"></span></div>
    <button id="intent-button" class="button">Intent</button>
    <p id="response" class="text"></p>
    <h3 class="text">References</h3>
    <span class="text">1. Alexa-Utterance-Generator, tejashah88,</span> <a href="https://github.com/tejashah88/Alexa-Utterance-Generator">github.com/tejashah88/Alexa-Utterance-Generator</a>

    <script>
        const REGION = "us-east-1";
        const ACCOUNT = "352743131672";
        const ANSWER_QUERY_FUNC = "answerQuery";

        var lexmodelbuildingservice;
        var lambda;

        function putIntentPutBot() {
            const botName = $('#bot-name').val();
            const intentName = $('#intent-name').val();
            const utterance = [$('#utterance').val()];

            const botParams = {
                name: botName,
                versionOrAlias: "$LATEST"
            };
            const permissionParams = {
                Action: "lambda:InvokeFunction",
                FunctionName: ANSWER_QUERY_FUNC,
                Principal: "lex.amazonaws.com",
                SourceArn: "arn:aws:lex:" + REGION + ":" + ACCOUNT + ":intent:" + intentName + ":*",
                StatementId: "lexlam-" + uuidv4()
            };
            const intentParams = {
                name: intentName,
                fulfillmentActivity: {
                    type: "CodeHook",
                    codeHook: {
                        uri: "arn:aws:lambda:" + REGION + ":" + ACCOUNT + ":function:" + ANSWER_QUERY_FUNC,
                        messageVersion: "1.0"
                    }
                },
                sampleUtterances: utterance
            };

            var currentBot;
            var currentOperation = "Get bot";

            $('#intent-status').text("");

            lexmodelbuildingservice.getBot(botParams).promise() // Get bot
                .then(function (data) {
                    console.log(data);
                    $('#intent-status').append('<span style="color:green">' + currentOperation + ' ok. </span>');
                    currentBot = data;
                    delete currentBot.status;
                    delete currentBot.failureReason;
                    delete currentBot.lastUpdatedDate;
                    delete currentBot.createdDate;
                    delete currentBot.version;
                    currentOperation = "Add permission";
                    return lambda.addPermission(permissionParams).promise(); // Add permissions
                })
                .then(function (data) {
                    console.log(data);
                    $('#intent-status').append('<span style="color:green">' + currentOperation + ' ok. </span>');
                    currentOperation = "Add intent";
                    return lexmodelbuildingservice.putIntent(intentParams).promise(); // Add intent
                })
                .then(function (data) {
                    console.log(data);
                    $('#intent-status').append('<span style="color:green">' + currentOperation + ' ok. </span>');
                    currentOperation = "Update bot";
                    currentBot.intents.push({
                        intentName: intentName,
                        intentVersion: "$LATEST"
                    });
                    return lexmodelbuildingservice.putBot(currentBot).promise(); // Update bot
                })
                .then(function (data) {
                    console.log(data);
                    $('#intent-status').append('<span style="color:green">' + currentOperation + ' ok. </span>');
                    currentOperation = "Add Db";
                    // Add Db
                })
                .catch(function (err) {
                    console.log(err)
                    $('#intent-status').append('<span style="color:red">' + currentOperation + ' error: ' + err + ' </span>');
                });

        }

        function getBot(name) {
            var params = {
                name: name,
                versionOrAlias: "$LATEST"
            };
            lexmodelbuildingservice.getBot(params, function (err, data) {
                if (err) {
                    console.log(err, err.stack);
                    $('#bot-status').text("The bot could no be loaded. Error: " + err);
                    $('#bot-status').attr("style", "color:red");
                } else {
                    console.log(data);
                    $('#bot-status').text("Bot loaded. Last updated: " + new Date(data.lastUpdatedDate).toLocaleString('en-AU'));
                    $('#bot-status').attr("style", "color:green");
                }
            });;
        }

        function randomChar5() {
            return 'xxxxx'.replace(/[xy]/g, function (c) {
                return String.fromCharCode(Math.floor(Math.random() * 26) + 97);
            });
        }

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }


        $('#check-button').click(function () {
            getBot($('#bot-name').val());
        });

        $('#submit-button').click(function () {
            //addPermission($('#intent-name').val());
            putIntentPutBot();
        });

        $('#intent-button').click(function () {
            //putIntent($('#intent-name').val(), [$('#utterance').val()])
            // getPolicy();
        });

        $(document).ready(function () {
            // AWS initialization
            AWS.config.update({
                region: REGION,
                credentials: new AWS.Credentials($('#id').val(), $('#key').val())
            });

            AWS.config.credentials.get(function (err) {
                console.log("credential error status: " + (err ? err : "no error"));
            });

            lexmodelbuildingservice = new AWS.LexModelBuildingService();
            lambda = new AWS.Lambda();

            $('#intent-name').val("test_intent_" + randomChar5());
            $('#utterance').text("utterance one " + randomChar5() + "\nutterance two " + randomChar5());
        });
    </script>
</body>

</html>
